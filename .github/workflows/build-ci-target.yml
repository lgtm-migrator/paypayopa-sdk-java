name: PayPay PHP SDK Upload CI Results
on:
  workflow_run:
    workflows: ["PayPay Java SDK CI"]
    types: ["completed"]
jobs:
  upload-codeclimate:
    runs-on: ubuntu-latest
    steps:

    - name: Clone PR branch
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.workflow_run.head_branch }}

    - name: Download codeclimate reporter
      run: |
           curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ../cc-test-reporter && chmod +x ../cc-test-reporter

    - name: codeclimate before-build
      env: 
        CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID}}
        GIT_COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
        GIT_BRANCH: ${{ github.event.workflow_run.head_branch }}
      run: |
           ../cc-test-reporter before-build

    - name: Download coverage from CI run
      uses: actions/github-script@v3.1.0
      with:
        script: |
          const coverageArtifactName = "jacoco-coverage";
          var artifacts = await github.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{github.event.workflow_run.id }},
          });
          var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
            return artifact.name == coverageArtifactName;
          })[0];
          if (!matchArtifact) {
            console.error(artifacts);
            throw new Error("did not find expected artifact `" + artifactName + "`");
          }
          var download = await github.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
          });
          var fs = require('fs');
          fs.writeFileSync('${{github.workspace}}/coverage-artifact.zip', Buffer.from(download.data));

    - run: unzip -j coverage-artifact.zip jacocoTestReport.xml -d ..

    - name: codeclimate after-build
      env:
        CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID}}
        GIT_COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
        GIT_BRANCH: ${{ github.event.workflow_run.head_branch }}
      run: |
           JACOCO_SOURCE_PATH=src/main/java ../cc-test-reporter format-coverage ../jacocoTestReport.xml --input-type jacoco
           ../cc-test-reporter upload-coverage
